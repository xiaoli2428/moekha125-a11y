<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi Timezone Digital Clock â€” Persistent & Searchable</title>
  <style>
    :root{
      --bg:#071124;
      --card:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      color-scheme: dark;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#071124 0%, #08122a 60%);
      color:#e6eef6;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px;
    }
    .container{
      width:100%;
      max-width:1100px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:20px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    header h1{
      margin:0;
      font-size:18px;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search-wrap{
      position:relative;
      width:360px;
      max-width:60vw;
    }
    .search {
      width:100%;
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      outline:none;
    }
    .listbox {
      position:absolute;
      top:110%;
      left:0;
      right:0;
      max-height:220px;
      overflow:auto;
      background:rgba(2,6,23,0.98);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:8px;
      z-index:40;
      box-shadow:0 8px 24px rgba(2,6,23,0.6);
    }
    .option {
      padding:8px 10px;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
    }
    .option:hover, .option[aria-selected="true"]{
      background:rgba(6,182,212,0.08);
      color:#dffafe;
    }
    select, button, input[type=checkbox]{
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      outline:none;
    }
    button.primary{
      background:linear-gradient(90deg,var(--accent),#60a5fa);
      color:#042027;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    .zones{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
      margin-top:16px;
    }
    .zone{
      background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .zone .tz{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .zone .tz .name{
      font-weight:700;
      font-size:13px;
      color:#dbeafe;
      word-break:break-all;
    }
    .zone .tz .meta{
      font-size:12px;
      color:var(--muted);
    }
    .zone .tz .remove{
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      font-size:16px;
      padding:6px;
      border-radius:6px;
    }
    .zone .time{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size:20px;
      letter-spacing:0.6px;
      color:#f0f9ff;
    }
    .zone .date{
      font-size:12px;
      color:var(--muted);
    }
    .footer-note{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
    }
    .empty{
      color:var(--muted);
      padding:18px;
      border:1px dashed rgba(255,255,255,0.03);
      border-radius:8px;
      text-align:center;
    }

    @media (max-width:720px){
      .search-wrap{width:100%}
      header{flex-direction:column;align-items:flex-start;gap:12px}
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Multi timezone digital clock">
    <header>
      <h1>Persistent Multi Timezone Clock</h1>
      <div class="controls" aria-hidden="false">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);">
          <input id="hour12" type="checkbox" />
          12-hour
        </label>

        <div class="search-wrap" id="searchWrap">
          <input id="tz-search" class="search" type="search" placeholder="Search or paste IANA timezone (e.g. America/New_York)" aria-label="Search timezones">
          <div id="tz-listbox" class="listbox" role="listbox" hidden></div>
        </div>

        <button id="add-tz" class="primary">Add</button>
        <button id="reset" title="Reset saved zones to defaults" aria-label="Reset saved zones">Reset</button>
      </div>
    </header>

    <main>
      <div id="zones" class="zones" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>No zones added yet. Use the search box to add time zones.</div>
      <div class="footer-note">
        Tip: Add time zones from the searchable list. Your selected zones and 12/24 preference are stored in localStorage.
      </div>
    </main>
  </div>

  <script>
  (function(){
    // LocalStorage keys
    const LS_ZONES_KEY = 'multiClock:zones';
    const LS_HOUR12_KEY = 'multiClock:hour12';

    // Try to get full list from Intl if available, otherwise fallback to built-in list.
    // Intl.supportedValuesOf('timeZone') is supported in modern browsers; fallback used for older browsers.
    let ALL_TIMEZONES = [];
    if (typeof Intl === 'object' && typeof Intl.supportedValuesOf === 'function') {
      try {
        ALL_TIMEZONES = Intl.supportedValuesOf('timeZone');
      } catch (e) {
        ALL_TIMEZONES = [];
      }
    }

    // Fallback list (comprehensive but not exhaustive). This covers common IANA zones.
    const BUILTIN_ZONES = [
      "Africa/Abidjan","Africa/Accra","Africa/Addis_Ababa","Africa/Algiers","Africa/Asmara","Africa/Bamako","Africa/Bangui",
      "Africa/Banjul","Africa/Bissau","Africa/Blantyre","Africa/Brazzaville","Africa/Bujumbura","Africa/Cairo","Africa/Casablanca",
      "Africa/Ceuta","Africa/Conakry","Africa/Dakar","Africa/Dar_es_Salaam","Africa/Djibouti","Africa/Douala","Africa/El_Aaiun",
      "Africa/Freetown","Africa/Gaborone","Africa/Harare","Africa/Johannesburg","Africa/Juba","Africa/Kampala","Africa/Khartoum",
      "Africa/Kigali","Africa/Kinshasa","Africa/Lagos","Africa/Libreville","Africa/Lome","Africa/Luanda","Africa/Lubumbashi",
      "Africa/Lusaka","Africa/Malabo","Africa/Maputo","Africa/Maseru","Africa/Mbabane","Africa/Mogadishu","Africa/Monrovia",
      "Africa/Nairobi","Africa/Ndjamena","Africa/Niamey","Africa/Nouakchott","Africa/Ouagadougou","Africa/Porto-Novo","Africa/Sao_Tome",
      "Africa/Tripoli","Africa/Tunis","Africa/Windhoek",
      "America/Adak","America/Anchorage","America/Anguilla","America/Antigua","America/Araguaina","America/Argentina/Buenos_Aires",
      "America/Argentina/Catamarca","America/Argentina/Cordoba","America/Argentina/Jujuy","America/Argentina/La_Rioja",
      "America/Argentina/Mendoza","America/Argentina/Rio_Gallegos","America/Argentina/Salta","America/Argentina/San_Juan",
      "America/Argentina/San_Luis","America/Argentina/Tucuman","America/Argentina/Ushuaia","America/Aruba","America/Asuncion",
      "America/Atikokan","America/Bahia","America/Bahia_Banderas","America/Barbados","America/Belem","America/Belize","America/Blanc-Sablon",
      "America/Boa_Vista","America/Bogota","America/Boise","America/Cambridge_Bay","America/Campo_Grande","America/Cancun",
      "America/Caracas","America/Cayenne","America/Cayman","America/Chicago","America/Chihuahua","America/Costa_Rica","America/Creston",
      "America/Cuiaba","America/Curacao","America/Danmarkshavn","America/Dawson","America/Dawson_Creek","America/Denver",
      "America/Detroit","America/Dominica","America/Edmonton","America/Eirunepe","America/El_Salvador","America/Fort_Nelson",
      "America/Fortaleza","America/Glace_Bay","America/Godthab","America/Goose_Bay","America/Grand_Turk","America/Grenada",
      "America/Guadeloupe","America/Guatemala","America/Guayaquil","America/Guyana","America/Halifax","America/Havana",
      "America/Hermosillo","America/Indiana/Indianapolis","America/Indiana/Knox","America/Indiana/Marengo","America/Indiana/Petersburg",
      "America/Indiana/Tell_City","America/Indiana/Vevay","America/Indiana/Vincennes","America/Indiana/Winamac","America/Inuvik",
      "America/Iqaluit","America/Jamaica","America/Juneau","America/Kentucky/Louisville","America/Kentucky/Monticello","America/Kralendijk",
      "America/La_Paz","America/Lima","America/Los_Angeles","America/Lower_Princes","America/Maceio","America/Managua","America/Manaus",
      "America/Marigot","America/Martinique","America/Matamoros","America/Mazatlan","America/Menominee","America/Merida","America/Metlakatla",
      "America/Mexico_City","America/Miquelon","America/Moncton","America/Monterrey","America/Montevideo","America/Montserrat",
      "America/Nassau","America/New_York","America/Nipigon","America/Nome","America/Noronha","America/North_Dakota/Beulah",
      "America/North_Dakota/Center","America/North_Dakota/New_Salem","America/Ojinaga","America/Panama","America/Pangnirtung",
      "America/Paramaribo","America/Phoenix","America/Port-au-Prince","America/Port_of_Spain","America/Porto_Velho","America/Puerto_Rico",
      "America/Punta_Arenas","America/Rainy_River","America/Rankin_Inlet","America/Recife","America/Regina","America/Resolute",
      "America/Rio_Branco","America/Santarem","America/Santiago","America/Santo_Domingo","America/Sao_Paulo","America/Scoresbysund",
      "America/Sitka","America/St_Barthelemy","America/St_Johns","America/St_Kitts","America/St_Lucia","America/St_Thomas",
      "America/St_Vincent","America/Swift_Current","America/Tegucigalpa","America/Thule","America/Thunder_Bay","America/Tijuana",
      "America/Toronto","America/Tortola","America/Vancouver","America/Whitehorse","America/Winnipeg","America/Yakutat",
      "America/Yellowknife",
      "Antarctica/Casey","Antarctica/Davis","Antarctica/DumontDUrville","Antarctica/Macquarie","Antarctica/Mawson","Antarctica/McMurdo",
      "Antarctica/Palmer","Antarctica/Rothera","Antarctica/Syowa","Antarctica/Troll","Antarctica/Vostok",
      "Arctic/Longyearbyen",
      "Asia/Aden","Asia/Almaty","Asia/Amman","Asia/Anadyr","Asia/Aqtau","Asia/Aqtobe","Asia/Ashgabat","Asia/Atyrau",
      "Asia/Baghdad","Asia/Bahrain","Asia/Baku","Asia/Bangkok","Asia/Barnaul","Asia/Beirut","Asia/Bishkek","Asia/Brunei",
      "Asia/Chita","Asia/Choibalsan","Asia/Colombo","Asia/Damascus","Asia/Dhaka","Asia/Dili","Asia/Dubai","Asia/Dushanbe",
      "Asia/Famagusta","Asia/Gaza","Asia/Hebron","Asia/Ho_Chi_Minh","Asia/Hong_Kong","Asia/Hovd","Asia/Irkutsk","Asia/Jakarta",
      "Asia/Jayapura","Asia/Jerusalem","Asia/Kabul","Asia/Kamchatka","Asia/Karachi","Asia/Kathmandu","Asia/Khandyga","Asia/Kolkata",
      "Asia/Krasnoyarsk","Asia/Kuala_Lumpur","Asia/Kuching","Asia/Kuwait","Asia/Macau","Asia/Magadan","Asia/Makassar","Asia/Manila",
      "Asia/Muscat","Asia/Nicosia","Asia/Novokuznetsk","Asia/Novosibirsk","Asia/Omsk","Asia/Oral","Asia/Phnom_Penh","Asia/Pontianak",
      "Asia/Pyongyang","Asia/Qatar","Asia/Qyzylorda","Asia/Riyadh","Asia/Sakhalin","Asia/Samarkand","Asia/Seoul","Asia/Shanghai",
      "Asia/Singapore","Asia/Srednekolymsk","Asia/Taipei","Asia/Tashkent","Asia/Tbilisi","Asia/Tehran","Asia/Thimphu","Asia/Tokyo",
      "Asia/Tomsk","Asia/Ulaanbaatar","Asia/Urumqi","Asia/Ust-Nera","Asia/Vladivostok","Asia/Yakutsk","Asia/Yekaterinburg","Asia/Yerevan",
      "Atlantic/Azores","Atlantic/Bermuda","Atlantic/Canary","Atlantic/Cape_Verde","Atlantic/Faroe","Atlantic/Madeira","Atlantic/Reykjavik",
      "Atlantic/South_Georgia","Atlantic/St_Helena","Atlantic/Stanley",
      "Australia/Adelaide","Australia/Brisbane","Australia/Broken_Hill","Australia/Currie","Australia/Darwin","Australia/Eucla",
      "Australia/Hobart","Australia/Lindeman","Australia/Lord_Howe","Australia/Melbourne","Australia/Perth","Australia/Sydney",
      "Europe/Amsterdam","Europe/Andorra","Europe/Astrakhan","Europe/Athens","Europe/Belgrade","Europe/Berlin","Europe/Bratislava",
      "Europe/Brussels","Europe/Bucharest","Europe/Budapest","Europe/Busingen","Europe/Chisinau","Europe/Copenhagen","Europe/Dublin",
      "Europe/Gibraltar","Europe/Guernsey","Europe/Helsinki","Europe/Isle_of_Man","Europe/Istanbul","Europe/Jersey","Europe/Kaliningrad",
      "Europe/Kiev","Europe/Kirov","Europe/Lisbon","Europe/Ljubljana","Europe/London","Europe/Luxembourg","Europe/Madrid",
      "Europe/Malta","Europe/Mariehamn","Europe/Minsk","Europe/Monaco","Europe/Moscow","Europe/Oslo","Europe/Paris","Europe/Podgorica",
      "Europe/Prague","Europe/Riga","Europe/Rome","Europe/Samara","Europe/San_Marino","Europe/Sarajevo","Europe/Saratov",
      "Europe/Simferopol","Europe/Skopje","Europe/Sofia","Europe/Stockholm","Europe/Tallinn","Europe/Tirane","Europe/Ulyanovsk",
      "Europe/Uzhgorod","Europe/Vaduz","Europe/Vatican","Europe/Vienna","Europe/Vilnius","Europe/Volgograd","Europe/Warsaw",
      "Europe/Zagreb","Europe/Zaporozhye","Europe/Zurich",
      "Pacific/Auckland","Pacific/Fiji","Pacific/Guadalcanal","Pacific/Guam","Pacific/Honolulu","Pacific/Marquesas","Pacific/Midway",
      "Pacific/Nauru","Pacific/Niue","Pacific/Norfolk","Pacific/Pago_Pago","Pacific/Palau","Pacific/Port_Moresby","Pacific/Saipan",
      "Pacific/Tahiti","Pacific/Wallis"
    ];

    if (!ALL_TIMEZONES || !ALL_TIMEZONES.length) {
      ALL_TIMEZONES = BUILTIN_ZONES.slice();
    }

    // Sort list for predictability
    ALL_TIMEZONES.sort((a,b) => a.localeCompare(b));

    // DOM elements
    const zonesContainer = document.getElementById('zones');
    const tzSearch = document.getElementById('tz-search');
    const tzListbox = document.getElementById('tz-listbox');
    const addBtn = document.getElementById('add-tz');
    const hour12Checkbox = document.getElementById('hour12');
    const resetBtn = document.getElementById('reset');
    const emptyEl = document.getElementById('empty');

    // State
    let zoneOrder = []; // array of timezone strings
    const zoneElements = new Map();

    // Helpers: localStorage persistence
    function saveState() {
      try {
        localStorage.setItem(LS_ZONES_KEY, JSON.stringify(zoneOrder));
        localStorage.setItem(LS_HOUR12_KEY, JSON.stringify(Boolean(hour12Checkbox.checked)));
      } catch (e) {
        console.warn('Failed to save settings to localStorage', e);
      }
    }
    function loadState() {
      try {
        const rawZones = localStorage.getItem(LS_ZONES_KEY);
        const rawHour12 = localStorage.getItem(LS_HOUR12_KEY);
        if (rawZones) {
          const parsed = JSON.parse(rawZones);
          if (Array.isArray(parsed)) zoneOrder = parsed;
        }
        if (rawHour12 !== null) {
          hour12Checkbox.checked = JSON.parse(rawHour12);
        }
      } catch (e) {
        console.warn('Failed to load settings from localStorage', e);
      }
    }

    // Default zones
    function defaultZones() {
      const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
      return [localTZ, 'UTC', 'America/New_York', 'Europe/London', 'Asia/Tokyo'];
    }

    // Validate timezone by attempting to format with it
    function isValidTimeZone(tz) {
      try {
        // If timezone is not valid, Intl will throw RangeError
        new Intl.DateTimeFormat('en-US', { timeZone: tz }).format();
        return true;
      } catch (e) {
        return false;
      }
    }

    // UI: searchable list
    function renderListbox(filter='') {
      const q = String(filter || '').trim().toLowerCase();
      tzListbox.innerHTML = '';
      // Show top matches; allow typed exact paste to be added even if not in list
      const results = ALL_TIMEZONES.filter(tz => tz.toLowerCase().includes(q));
      // If user typed something that is not exactly in list but looks like IANA, show it
      if (q && !ALL_TIMEZONES.some(t => t.toLowerCase() === q)) {
        // allow adding the typed value if it looks like contains "/" or underscore or letters
        const candidate = filter.trim();
        if (candidate.length && /[A-Za-z].*\/.*/.test(candidate)) {
          const customOpt = document.createElement('div');
          customOpt.className = 'option';
          customOpt.textContent = `${candidate} (custom)`;
          customOpt.dataset.tz = candidate;
          customOpt.addEventListener('click', () => {
            addZone(candidate);
            hideListbox();
            tzSearch.value = '';
          });
          tzListbox.appendChild(customOpt);
        }
      }

      results.slice(0, 150).forEach(tz => {
        const el = document.createElement('div');
        el.className = 'option';
        el.textContent = tz;
        el.dataset.tz = tz;
        el.role = 'option';
        el.tabIndex = 0;
        el.addEventListener('click', () => {
          addZone(tz);
          hideListbox();
          tzSearch.value = '';
        });
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            addZone(tz);
            hideListbox();
            tzSearch.value = '';
          }
        });
        tzListbox.appendChild(el);
      });

      if (!results.length && !tzListbox.childElementCount) {
        const no = document.createElement('div');
        no.className = 'option';
        no.style.opacity = '0.7';
        no.textContent = 'No match';
        tzListbox.appendChild(no);
      }

      tzListbox.hidden = false;
    }

    function hideListbox() {
      tzListbox.hidden = true;
    }

    // Create zone card UI
    function createZoneCard(tz) {
      if (zoneElements.has(tz)) return; // duplicate guard

      const card = document.createElement('section');
      card.className = 'zone';
      card.dataset.timezone = tz;

      const tzline = document.createElement('div');
      tzline.className = 'tz';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = tz;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = ''; // will be offset info later

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.flexDirection = 'column';
      left.style.gap = '4px';
      left.appendChild(name);
      left.appendChild(meta);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove';
      removeBtn.setAttribute('aria-label', `Remove ${tz}`);
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', () => {
        removeZone(tz);
      });

      tzline.appendChild(left);
      tzline.appendChild(removeBtn);

      const timeEl = document.createElement('div');
      timeEl.className = 'time';
      timeEl.textContent = '00:00:00';

      const dateEl = document.createElement('div');
      dateEl.className = 'date';
      dateEl.textContent = '';

      card.appendChild(tzline);
      card.appendChild(timeEl);
      card.appendChild(dateEl);

      zonesContainer.appendChild(card);
      zoneElements.set(tz, { card, timeEl, dateEl, meta });

      // compute offset and update initially
      updateZone(tz);
    }

    function removeZone(tz) {
      if (!zoneElements.has(tz)) return;
      const entry = zoneElements.get(tz);
      entry.card.remove();
      zoneElements.delete(tz);
      zoneOrder = zoneOrder.filter(z => z !== tz);
      saveState();
      updateEmptyState();
    }

    function addZone(tz) {
      const candidate = String(tz || '').trim();
      if (!candidate) return;
      if (!isValidTimeZone(candidate)) {
        alert('Invalid IANA timezone: ' + candidate);
        return;
      }
      if (!zoneOrder.includes(candidate)) {
        zoneOrder.push(candidate);
        createZoneCard(candidate);
        saveState();
        updateEmptyState();
      }
    }

    function formatForZone(date, timeZone, hour12) {
      const timeFormatter = new Intl.DateTimeFormat(undefined, {
        timeZone,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12
      });
      const dateFormatter = new Intl.DateTimeFormat(undefined, {
        timeZone,
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: '2-digit'
      });
      return {
        time: timeFormatter.format(date),
        date: dateFormatter.format(date)
      };
    }

    function getOffsetString(timeZone) {
      // Calculate current offset in hours from UTC for the timezone
      try {
        const now = new Date();
        const tzDate = new Date(now.toLocaleString('en-US', { timeZone }));
        // difference in minutes
        const diffMin = (tzDate.getTime() - now.getTime()) / (60 * 1000);
        const hours = Math.round(diffMin / 60 * 100) / 100; // two decimals
        const sign = hours >= 0 ? '+' : '-';
        const abs = Math.abs(hours);
        return `UTC${sign}${abs}`;
      } catch (e) {
        return '';
      }
    }

    function updateZone(tz) {
      const entry = zoneElements.get(tz);
      if (!entry) return;
      try {
        const now = new Date();
        const hour12 = hour12Checkbox.checked;
        const { time, date } = formatForZone(now, tz, hour12);
        entry.timeEl.textContent = time;
        entry.dateEl.textContent = date;
        // meta: offset
        const offset = getOffsetString(tz);
        entry.meta.textContent = offset ? offset : '';
      } catch (err) {
        entry.timeEl.textContent = 'Invalid timezone';
        entry.dateEl.textContent = '';
        entry.meta.textContent = '';
      }
    }

    function updateAll() {
      for (const tz of zoneOrder) updateZone(tz);
    }

    function renderZonesFromState() {
      zonesContainer.innerHTML = '';
      zoneElements.clear();
      if (!zoneOrder.length) {
        emptyEl.hidden = false;
      } else {
        emptyEl.hidden = true;
        for (const tz of zoneOrder) {
          if (isValidTimeZone(tz)) createZoneCard(tz);
        }
      }
    }

    function updateEmptyState() {
      emptyEl.hidden = zoneOrder.length > 0;
    }

    // Reset to defaults
    function resetToDefaults() {
      if (!confirm('Reset saved zones and 12/24-hour preference to defaults?')) return;
      zoneOrder = defaultZones();
      hour12Checkbox.checked = false;
      saveState();
      renderZonesFromState();
      updateAll();
    }

    // Event wiring
    tzSearch.addEventListener('input', (e) => {
      const v = tzSearch.value.trim();
      if (v.length === 0) {
        hideListbox();
        return;
      }
      renderListbox(v);
    });

    tzSearch.addEventListener('focus', () => {
      const v = tzSearch.value.trim();
      if (v) renderListbox(v);
    });

    tzSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        tzSearch.value = '';
        hideListbox();
        tzSearch.blur();
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = tzSearch.value.trim();
        if (!val) return;
        // prefer exact match from list
        const exact = ALL_TIMEZONES.find(t => t.toLowerCase() === val.toLowerCase());
        addZone(exact || val);
        tzSearch.value = '';
        hideListbox();
      }
    });

    // Clicking outside hides listbox
    document.addEventListener('click', (e) => {
      if (!document.getElementById('searchWrap').contains(e.target)) {
        hideListbox();
      }
    });

    addBtn.addEventListener('click', () => {
      const val = tzSearch.value.trim();
      if (!val) {
        alert('Search or paste a timezone (e.g. America/Los_Angeles) and press Add.');
        return;
      }
      const exact = ALL_TIMEZONES.find(t => t.toLowerCase() === val.toLowerCase());
      addZone(exact || val);
      tzSearch.value = '';
      hideListbox();
    });

    hour12Checkbox.addEventListener('change', () => {
      saveState();
      updateAll();
    });

    resetBtn.addEventListener('click', resetToDefaults);

    // Init
    loadState();
    if (!zoneOrder.length) {
      zoneOrder = defaultZones();
    }
    renderZonesFromState();
    updateAll();
    updateEmptyState();

    // Update every second
    setInterval(updateAll, 1000);

    // Expose for debugging (optional)
    window.multiClock = {
      addZone, removeZone, zoneOrder, saveState, loadState, ALL_TIMEZONES
    };
  })();
  </script>
</body>
</html>